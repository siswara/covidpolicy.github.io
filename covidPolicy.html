<html>
    <head>
        <title>Covid-19 Related Public Health Policy</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@200&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@600&display=swap" rel="stylesheet">
        <style>
            body{
                font-family: 'Mulish', sans-serif;   
            }
            button {
               border: none;
               border-radius: 0px;
               transition-duration: 0.4s;
            }
            button:hover {
                background-color: #4CAF50; /* Green */
                color: white;
            }
            .sceneSelected {
                background-color: #4CAF50; /* Green */
                color: white;
            }
            .leftDiv{
                width: 300px;
                height: 350px;
                border: 2px;
                border-color: grey;
                border-style: none solid none none;
                padding: 10px;
                margin: 10px;
                float:left;
            }
            .rightDiv{
                width: 700px;
                height: 350px;
                border: 2px;
                /*border-color: grey;
                border-style: solid;*/
                padding-left: 10px;
                margin-left: 5px;
                float:left;
            }
            .hide{
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>Covid-19 Related Public Health Policy</h1>
        <p>In the past couple of months, how does US policy response to covid shapes infection rate. How does this compare to other mathematical modelling and other country.</p>
        <div class="leftDiv">
            <button id="buttonScene1" onclick="openScene1()" class="sceneSelected">1</button>
            <button id="buttonScene2" onclick="openScene2()">2</button>
            <button id="buttonScene3" onclick="openScene3()">3</button>
            <button id="buttonScene4" onclick="openScene4()">4</button>
            <button id="buttonScene5" onclick="openScene5()">5</button>
            <div id="scene1">
                <p>
                    <b>EARLY PROJECTIONS</b><br> 
                    In the early months of corona virus pandemic (End of March/Early April 2020), we can see how projection predicts high number of future covid-19 cases. 
                </p>
            </div>
            <div id="scene2" class="hide">
                <p>
                    <b>IMPLEMENTATION PUBLIC CLOSURE</b><br> 
                    Goverments around the world start implementing policy of public closure in anticipation of corona pandemic.
                </p>
            </div>
            <div id="scene3" class="hide">
                <p>
                    <b>SELF-QUARANTINE EASING</b><br> 
                    As pandemic progresses, some goverment shows decreases in infection rate and start to relax public closure policy.  However this policy affect vary across countries.
                </p>
            </div>
            <div id="scene4" class="hide">
                <p>
                    <b>FUTURE PROJECTION</b><br> 
                    With new policy implementation of mandatory mask, social distancing and public reopen will infection rate follow the predictive model? Only time will tell, but we can play our role slowing down the spread by waring mask and social distance.
                </p>
            </div>
            <div id="scene5" class="hide">
                    <p>
                        <b>References</b><br> 
                        <ul>
                            <li>Literature source for prediction model <a href="https://www.medrxiv.org/content/10.1101/2020.03.21.20039867v1.full.pdf">A New, Simple Projection Model for COVID-19 Pandemic.pdf</a></li>
                            <li>WHO covid data <a href="https://data.humdata.org/dataset/coronavirus-covid-19-cases-and-deaths">Coronavirus (COVID-19) Cases and Deaths</a></li>
                        </ul>
                    </p>
            </div>
        </div>
        <div class="rightDiv">
            <p>
                country 
                <select name="country" id="country" onchange="updateCountry()">
                    <option value="United States of America">United States of America</option>
                    <option value="Germany">Germany</option>
                    <option value="Italy">Italy</option>
                    <option value="New Zealand">New Zealand</option>
                    <option value="Republic of Korea">South Korea</option>
                    <option value="Sweden">Sweden</option>
                </select>
            </p>
            <svg id="graph"></svg>
        </div>
        
        <script>
            var strictIsoParse = d3.utcParse("%Y-%m-%dT%H:%M:%S.%LZ");
            var countryData = {}; //need to graoup data per country
            var countrySelection = 'United States of America';
            var countryOptions = {
                'USA' : 'United States of America',
                'GER' : 'Germany',
                'ITA' : 'Italy',
                'NZL' : 'New Zealand',
                'KOR' : 'Republic of Korea',
                'SWE' : 'Sweden',
            };
            var activeScene = 1;

            var x; //sepcified for global sharing :(
            var y;

            //setup canvas
            var margin = {top: 10, right: 30, bottom: 30, left: 60},
            width = 700 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;

            console.log(d3.select("#graph"));

            var svg = d3.select('svg')
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
            

            d3.csv('\Data_WHO_Coronavirus_Covid_Cases_Deaths_data.csv', parse).then(process);
            
            function parse(data) {
                var y = strictIsoParse(data.date_epicrv);
                return {
                    "date_epicrv" : y,//y.getFullYear() + '-' + y.getMonth() + '-' + y.getDate(),
                    "ADM0_NAME" : data.ADM0_NAME, //Country Name
                    "NewCase" : Number(data.NewCase),
                    "CumCase" : Number(data.CumCase)
                };
            }    

            function process(data) {
                data.forEach(function(item){
                    if (!countryData.hasOwnProperty(item.ADM0_NAME)){
                        countryData[item.ADM0_NAME] = [];
                    }
                    countryData[item.ADM0_NAME].push(item);
                });
                console.log(countryData);
                
                //graph per country
                //genGraphAndAxis(countryData[countrySelection]);
                genScreenGraph();
                /*
                var sourceProjectingData = [];
                sourceProjectingData.push(countryData[countrySelection][100]);
                sourceProjectingData.push(countryData[countrySelection][101]);
                sourceProjectingData.push(countryData[countrySelection][102]);

                genProjectionGraph(sourceProjectingData, 0.0001, "purple");
                //genProjectionGraph(sourceProjectingData, 0.000125, "magenta");
                genProjectionGraph(sourceProjectingData, 0.00015, "red");
                //genProjectionGraph(sourceProjectingData, 0.0002, "green");
                genProjectionGraph(sourceProjectingData, 0.0003, "green");
                genProjectionGraph(sourceProjectingData, 0.00005, "grey");
                genProjectionGraph(sourceProjectingData, 0, "black");
                */
            }

            function genGraphAndAxis(data){
                //console.log(data);
                // Add X axis --> it is a date format
                x = d3.scaleTime()
                    //.domain(d3.extent(data, function(d) { return d.date_epicrv; }))
                    //.domain(dates)
                    .domain(d3.extent(/*data*/countryData['United States of America'], function(d) { return d.date_epicrv; }))
                    .range([ 0, width ]);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));
                
                // Add Y axis
                y = d3.scaleLinear()
                    .domain([0, d3.max(data, function(d) { return +d.CumCase; })])
                    .range([ height, 0 ]);
                svg.append("g")
                    .call(d3.axisLeft(y));

                svg.append('path')
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) { return x(d.date_epicrv) })
                        .y(function(d) { return y(d.CumCase) })
                    );
            }

            function genGraphAndAxisUntilDate(data,startDate){
                var startIndex = 0;
                var i = 0;
                data.forEach(function(item){
                    if (item.date_epicrv.getTime() == startDate.getTime()){
                        startIndex = i;
                    } else {
                        i++;
                    }
                });

                var slicedData = data.slice(0, startIndex+2);
                // Add X axis --> it is a date format
                x = d3.scaleTime()
                    //.domain(d3.extent(data, function(d) { return d.date_epicrv; }))
                    //.domain(dates)
                    .domain(d3.extent(/*data*/countryData['United States of America'], function(d) { return d.date_epicrv; }))
                    .range([ 0, width ]);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));
                // Add Y axis
                y = d3.scaleLinear()
                    .domain([0, d3.max(data, function(d) { return +d.CumCase; })])
                    .range([ height, 0 ]);
                svg.append("g")
                    .call(d3.axisLeft(y));

                svg.append('path')
                    .datum(slicedData)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) { return x(d.date_epicrv) })
                        .y(function(d) { return y(d.CumCase) })
                    );
            }

            function genProjectionGraph(data, rc, color){
                console.log(data);
                var projectionData = projection(data, rc, 50, "CumCase", "date_epicrv");
                console.log("projectionData : ");
                console.log(projectionData);

                svg.append('path')
                    .datum(projectionData)
                    .attr("fill", "none")
                    .attr("stroke", color)
                    .attr("stroke-dasharray", "2")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) { return x(d.date_epicrv) })
                        .y(function(d) { return y(d.CumCase) })
                    );                
            }

            function genProjectionFromStartDate(data,startDate){
                //console.log('startDate');
                //console.log(startDate);
                
                var startIndex = 0;
                var i = 0;
                data.forEach(function(item){
                    if (item.date_epicrv.getTime() == startDate.getTime()){
                        startIndex = i;
                    } else {
                        i++;
                    }
                });
                
                console.log('startIndex');
                console.log(startIndex);

                var sourceProjectingData = [];

                if (startIndex >= (data.length - 2)){
                    startIndex = data.length - 3;
                }

                sourceProjectingData.push(data[startIndex]);
                sourceProjectingData.push(data[startIndex+1]);
                sourceProjectingData.push(data[startIndex+2]);

                //do projection
                genProjectionGraph(sourceProjectingData, 0.003, "teal"); //best
                genProjectionGraph(sourceProjectingData, 0.0015, "orange"); //better
                genProjectionGraph(sourceProjectingData, 0.001, "red"); //not bad
                //genProjectionGraph(sourceProjectingData, 0.00005, "grey"); //bad
                //genProjectionGraph(sourceProjectingData, 0, "black"); //worst
            }

            function projection(data,Rc,days,dataField,dateField){ //project for the next 30 days
                var projectionData = [];
                projectionData.push(data[0]);
                projectionData.push(data[1]);
                projectionData.push(data[2]);
            
                var onePercentCounter = 0;
                var halfPercentCounter = 0;

                var tempDate = new Date(data[1][dateField].getTime());
            
                for (var i=2; i < days+1; i++){
                    Ri = projectionData[projectionData.length - 2][dataField]/projectionData[projectionData.length - 3][dataField];
                    
                    var increases = (Ri - (Rc * i));
                    //check half percent counter
                    if (halfPercentCounter > 0){
                        increases = 1.005;
                        halfPercentCounter--;
                        if (halfPercentCounter == 0) break;
                    }
                    //check one percent counter
                    else if (onePercentCounter > 0){
                        increases = 1.01;
                        onePercentCounter--;
                        if (onePercentCounter == 0){
                            halfPercentCounter = 10;
                        }
                    }
                    else if (increases < 1.01){
                        onePercentCounter = 10;
                        increases = 1.01;
                    }
                    var newProjection = {};
                    newProjection[dataField]=projectionData[i][dataField] * increases;//(1 + reducedIncrease);
                    
                    tempDate.setDate(tempDate.getDate() + 1);
                    newProjection[dateField] = new Date(tempDate.getTime());
                    projectionData.push(newProjection);
                }
            
                return projectionData;
            }

            function removeAllGraphs(){
                svg.selectAll('path').remove();
                svg.selectAll('g').remove();
                svg.append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
            }

            /*---- UPDATE TRIGGER ----*/
            
            function updateCountry(){
                countrySelection = document.getElementById("country").value;
                removeAllGraphs();
                //genGraphAndAxis(countryData[countrySelection]);
                //render graph based on screen selection
                genScreenGraph();
            }

            function genScreenGraph(){
                switch(activeScene){
                    case 1:
                        var startDate = new Date('2020-03-15T00:00:00.000Z');
                        switch(countrySelection){
                            case countryOptions.USA:
                                startDate = new Date('2020-04-05T00:00:00.000Z');
                                break;
                            case countryOptions.ITA:
                                startDate = new Date('2020-03-25T00:00:00.000Z');
                                break;
                            case countryOptions.NZL:
                                startDate = new Date('2020-03-25T00:00:00.000Z');
                                break;
                            case countryOptions.KOR:
                                startDate = new Date('2020-02-25T00:00:00.000Z');
                                break;
                            case countryOptions.SWE:
                                startDate = new Date('2020-03-25T00:00:00.000Z');
                                break;
                        }
                        //starting date is different for each country
                        genGraphAndAxisUntilDate(countryData[countrySelection], startDate);
                        genProjectionFromStartDate(countryData[countrySelection],startDate);
                        break;
                    case 2:
                        break;
                    case 3:
                        break;
                    case 4:
                        break;
                }
            }

            /*---- SCENE TRANSITION ----*/
            var buttonIds = [
                'buttonScene1',
                'buttonScene2',
                'buttonScene3',
                'buttonScene4',
                'buttonScene5'
            ];
            var sceneIds = [
                'scene1',
                'scene2',
                'scene3',
                'scene4',
                'scene5'
            ];
            function deselectAllButton(){
                buttonIds.forEach(function(id){
                    document.getElementById(id).className = '';
                });
            }
            function hideAllScene(){
                sceneIds.forEach(function(id){
                    document.getElementById(id).className = 'hide';
                });
            }
            function openScene1(){
                deselectAllButton();
                hideAllScene();
                document.getElementById(buttonIds[0]).className = 'sceneSelected';
                document.getElementById(sceneIds[0]).className = '';
                activeScene = 1;
                //graph re-rendering
            }
            function openScene2(){
                deselectAllButton();
                hideAllScene();
                document.getElementById(buttonIds[1]).className = 'sceneSelected';
                document.getElementById(sceneIds[1]).className = '';
                activeScene = 2;
                //graph re-rendering
            }
            function openScene3(){
                deselectAllButton();
                hideAllScene();
                document.getElementById(buttonIds[2]).className = 'sceneSelected';
                document.getElementById(sceneIds[2]).className = '';
                activeScene = 3;
                //graph re-rendering
            }
            function openScene4(){
                deselectAllButton();
                hideAllScene();
                document.getElementById(buttonIds[3]).className = 'sceneSelected';
                document.getElementById(sceneIds[3]).className = '';
                activeScene = 4;
                //graph re-rendering
            }
            function openScene5(){
                deselectAllButton();
                hideAllScene();
                document.getElementById(buttonIds[4]).className = 'sceneSelected';
                document.getElementById(sceneIds[4]).className = '';
                activeScene = 5;
                //graph re-rendering
            }
        </script>
    </body>
</html>